---
title:  开启网络线程 ~ 发出http请求
order: 3
type: skeleton
---

## DNS查询得到IP
如果输入的是域名，需要进行dns解析成IP，大致流程：
- 如果浏览器有缓存，直接使用浏览器缓存，否则使用本机缓存，在没有使用host的情况下
- 如果本地没有，向dns域名服务器查询（可能经过路由，路由也有缓存），查询到对应的IP

注意：
- 域名查询有可能经过了CDN调度器的（如果有CDN存储功能的话）
- DNS解析是很耗时的，如果解析域名过多，会让首屏加载变得过慢，可以考虑`dns-prefetch`优化

> [如何开启dns-prefetch](https://www.jianshu.com/p/7f58ddfc1392)

## TCP/IP请求
- http本质就是TCP/IP请求
- 建立连接：三次握手，抽象为：
  ```
  客户端：hello，你是sever么？
  服务端：hello，我是server，你是client么？
  客户端：yes，我是client！
  ```
- 断开连接：四次挥手，抽象为：
  ```
  主动方：我已经关闭了向你那边的主动通道了，只能被动接收了
  被动方：收到通道关闭的信息
  被动方：那我也告诉你，我这边向你的主动通道也关闭了
  主动方：最后收到数据，之后双方无法通信
  ```
- TCP将http长报文划分为短报文，通过三次握手与服务端建立连接，进行可靠传输
- 并发限制
  - 浏览器对同一域名下并发的tcp连接是有限制的（2-10个不等）
  - http1.0中往往一个资源下载就需要对应一个tcp/ip请求

- get和post区别
  - get产生一个数据包，post两个
    - get请求时，浏览器会把headers和data一起发送出去，服务器响应200（返回数据）
    - post请求时，浏览器先发送headers，服务器响应100 continue，浏览器再发送data，服务器响应200（返回数据）
  
> [请求类型](../../backend/http/1_http.html#类型)

## 五层因特网协议栈
- 从客户端发出http请求到服务器接受，中间会经过一系列流程

- 包括
  - 应用层：DNS解析成IP并发送http请求
  - 传输层：建立tcp连接（三次握手）
  - 网络层：IP寻址
  - 数据链路层：封装成帧
  - 物理层：利用物理介质传输比特流，传输的时候通过双绞线，电磁波等各种介质

- 完整的OSI七层框架
  - 应用层：DNS解析成IP并发送http请求
  - 表示层（OSI）：主要处理两个通信系统中交换信息的表示方式，包括数据格式交换，数据加密和解密，数据压缩和终端类型转换等
  - 会话层（OSI）：具体管理不同用户和进程之间的对话，如控制登录和注销过程
  - 传输层：建立tcp连接（三次握手）
  - 网络层：IP寻址
  - 数据链路层：封装成帧
  - 物理层：利用物理介质传输比特流，传输的时候通过双绞线，电磁波等各种介质

## 从服务器接受请求到对应后台接受请求

**在计算机世界里，由于单个服务器的处理客户端请求能力有一个极限，当用户的接入请求蜂拥而入时，会造成服务器忙不过来的局面，可以使用多个服务器来共同分担成千上万用户请求，这些服务器提供相同的服务，对于用户来说，根本感觉不到任何差别。**

### 实现
1. 需要有一个负载均衡设备来分发用户请求，将用户请求分发到空闲的服务器上
1. 服务器返回自己的服务到负载均衡设备
1. 负载均衡将服务器的服务返回用户

用户和负载均衡设备直接通信，也意味着用户做服务器域名解析时，解析得到的IP其实是负载均衡的IP，而不是服务器的IP，这样有一个好处是：当新加入/移走服务器时，仅仅需要修改负载均衡的服务器列表，而不会影响到现有的服务。

## 负载均衡
对于大型的项目，由于并发访问量很大，所以一台服务器是吃不消的，所以一般会有若干服务器组成一个集群，然后配合反向代理实现负载均衡，简单的说：
用户发起的请求都指向调度服务器（反向代理服务器，譬如安装了nginx控制负载均衡），然后调度服务器根据实际的调度算法，分配不同的请求给对应集群中的服务器执行，然后调度器等待实际服务器的HTTP响应，并将它反馈给用户。

![proxy](../../images/proxy.jpg)

## 后台处理
一般后台都是部署到容器中的，一般为：
- 容器接收到请求
- 对应容器中的后台程序接收到请求
- 后台程序处理后返回响应结果

概括：
- 一般有的后端是有统一的验证的，如安全拦截，跨域验证
- 如果这一步不符合规则，就直接返回了相应的http报文（如拒绝请求等）
- 然后当验证通过后，才会进入实际的后台代码，此时是程序接收到请求，然后执行（譬如查询数据库，大量计算等等）
- 等程序执行完毕后，就会返回一个http响应包（一般这一步也会经过多层封装）
- 然后就是将这个包从后端发送到前端，完成交互
